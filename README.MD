# üöÄ D·ª± √°n SONDAIMINH - H·ªá th·ªëng Qu·∫£n l√Ω B√°n S∆°n & Thi c√¥ng Ch·ªëng th·∫•m

## üåü T·ªïng quan

**SONDAIMINH** l√† m·ªôt ·ª©ng d·ª•ng web ASP.NET Core ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ qu·∫£n l√Ω to√†n di·ªán c√°c ho·∫°t ƒë·ªông kinh doanh li√™n quan ƒë·∫øn s·∫£n ph·∫©m s∆°n v√† d·ªãch v·ª• thi c√¥ng ch·ªëng th·∫•m. H·ªá th·ªëng bao g·ªìm:

*   **Trang Qu·∫£n tr·ªã (Admin Area):**
    *   Qu·∫£n l√Ω S·∫£n ph·∫©m: Th√™m, s·ª≠a, x√≥a s·∫£n ph·∫©m, danh m·ª•c, th∆∞∆°ng hi·ªáu, thu·ªôc t√≠nh, h√¨nh ·∫£nh.
    *   Qu·∫£n l√Ω N·ªôi dung: Qu·∫£n l√Ω b√†i vi·∫øt, trang tƒ©nh, banner, popup, FAQ.
    *   Qu·∫£n l√Ω T∆∞∆°ng t√°c: X·ª≠ l√Ω li√™n h·ªá, qu·∫£n l√Ω ƒë√°nh gi√° kh√°ch h√†ng, ƒëƒÉng k√Ω nh·∫≠n tin.
    *   Qu·∫£n l√Ω Ng∆∞·ªùi d√πng: Qu·∫£n l√Ω t√†i kho·∫£n qu·∫£n tr·ªã vi√™n, ph√¢n quy·ªÅn chi ti·∫øt.
    *   Qu·∫£n l√Ω C·∫•u h√¨nh h·ªá th·ªëng.
    *   Qu·∫£n l√Ω Media: T·∫£i l√™n, qu·∫£n l√Ω h√¨nh ·∫£nh v√† c√°c t·ªáp ƒëa ph∆∞∆°ng ti·ªán.
*   **Trang Kh√°ch h√†ng (Client Area):**
    *   Hi·ªÉn th·ªã s·∫£n ph·∫©m, b√†i vi·∫øt, th√¥ng tin c√¥ng ty.
    *   Ch·ª©c nƒÉng t√¨m ki·∫øm, l·ªçc s·∫£n ph·∫©m.
    *   G·ª≠i li√™n h·ªá, y√™u c·∫ßu b√°o gi√°.
    *   (Ti·ªÅm nƒÉng) ƒêƒÉng k√Ω/ƒêƒÉng nh·∫≠p t√†i kho·∫£n kh√°ch h√†ng, qu·∫£n l√Ω ƒë∆°n h√†ng, gi·ªè h√†ng.

**ƒêi·ªÉm n·ªïi b·∫≠t:**
*   Ki·∫øn tr√∫c ph√¢n l·ªõp r√µ r√†ng (Domain, Infrastructure, Shared, Web).
*   S·ª≠ d·ª•ng ASP.NET Core Identity cho x√°c th·ª±c v√† ph√¢n quy·ªÅn d·ª±a tr√™n Claim (Permission-based).
*   T√≠ch h·ª£p MinIO cho l∆∞u tr·ªØ file object storage.
*   H·ªó tr·ª£ c∆° s·ªü d·ªØ li·ªáu PostgreSQL (ƒë√£ chuy·ªÉn t·ª´ SQL Server).
*   Tri·ªÉn khai d·ªÖ d√†ng b·∫±ng Docker v√† Docker Compose.
*   Giao di·ªán qu·∫£n tr·ªã hi·ªán ƒë·∫°i, th√¢n thi·ªán v·ªõi ng∆∞·ªùi d√πng (d·ª±a tr√™n Tabler).

---

## üõ†Ô∏è C√¥ng ngh·ªá s·ª≠ d·ª•ng

### Backend
*   ASP.NET Core 8.0 (C#)
*   Entity Framework Core 8.0 (ORM)
*   PostgreSQL (C∆° s·ªü d·ªØ li·ªáu)
*   ASP.NET Core Identity (X√°c th·ª±c & Ph√¢n quy·ªÅn)
*   AutoMapper (√Ånh x·∫° ƒë·ªëi t∆∞·ª£ng)
*   FluentValidation (Validate d·ªØ li·ªáu)
*   Serilog (Logging)
*   MinIO (L∆∞u tr·ªØ file)
*   Redis (Cache - t√πy ch·ªçn)
*   X.PagedList (Ph√¢n trang)

### Frontend (Admin & Client)
*   Razor Views (.cshtml)
*   HTML5, CSS3, JavaScript
*   Tabler (Admin UI Template)
*   jQuery
*   Bootstrap 5
*   TomSelect (Select box n√¢ng cao)
*   Litepicker (Date picker)
*   HugerTE (WYSIWYG Editor - c√≥ th·ªÉ l√† TinyMCE)
*   Toastr (Th√¥ng b√°o)

### DevOps & Tri·ªÉn khai
*   Docker & Docker Compose
*   Git

---

## üèóÔ∏è C·∫•u tr√∫c D·ª± √°n

D·ª± √°n ƒë∆∞·ª£c t·ªï ch·ª©c th√†nh c√°c project ch√≠nh:

*   `src/domain`: Ch·ª©a c√°c Entities (th·ª±c th·ªÉ), enums, v√† logic nghi·ªáp v·ª• c·ªët l√µi kh√¥ng ph·ª• thu·ªôc v√†o c√¥ng ngh·ªá c·ª• th·ªÉ.
*   `src/infrastructure`: Ch·ª©a `DbContext`, migrations, repositories, v√† c√°c tri·ªÉn khai c·ª• th·ªÉ cho c∆° s·ªü d·ªØ li·ªáu v√† c√°c d·ªãch v·ª• b√™n ngo√†i (nh∆∞ MinIO).
*   `src/shared`: Ch·ª©a c√°c h·∫±ng s·ªë, enums, helpers, models d√πng chung cho c√°c project kh√°c.
*   `src/web`: D·ª± √°n ASP.NET Core MVC ch√≠nh, ch·ª©a Controllers, Views, ViewModels, Services (cho t·∫ßng application), Mappers, Validators.
    *   `Areas/Admin`: Ph√¢n h·ªá qu·∫£n tr·ªã.
    *   `Areas/Client`: Ph√¢n h·ªá cho ng∆∞·ªùi d√πng cu·ªëi.

---

## ‚öôÔ∏è Setup M√¥i tr∆∞·ªùng Development

### Y√™u c·∫ßu
*   .NET SDK 8.0 ho·∫∑c m·ªõi h∆°n.
*   M·ªôt IDE nh∆∞ Visual Studio 2022, JetBrains Rider, ho·∫∑c VS Code v·ªõi C# Dev Kit.
*   Docker Desktop.
*   Git.

### C√°c b∆∞·ªõc thi·∫øt l·∫≠p

1.  **Clone d·ª± √°n:**
    ```bash
    git clone https://github.com/hunlorvike/daiminh daiminh
    cd daiminh
    ```

2.  **C·∫•u h√¨nh file `appsettings.Development.json`:**
    M·ªü file `src/web/appsettings.Development.json` v√† c·∫≠p nh·∫≠t c√°c th√¥ng tin sau:
    ```json
    {
      "ConnectionStrings": {
        "DefaultConnection": "Host=localhost;Port=5432;Database=daiminh_pg;Username=your_postgres_user;Password=your_postgres_password_local_dev", // Thay b·∫±ng th√¥ng tin PostgreSQL c·ªßa b·∫°n
        "RedisConnection": "localhost:6380" // Ho·∫∑c port Redis b·∫°n d√πng
      },
      "Minio": {
        "Endpoint": "localhost:9000",
        "AccessKey": "minioadmin", // N√™n d√πng key kh√°c cho dev
        "SecretKey": "minioadmin", // N√™n d√πng secret kh√°c cho dev
        "BucketName": "daiminh-dev", // C√≥ th·ªÉ d√πng bucket ri√™ng cho dev
        "PublicBaseUrl": "http://localhost:9000/daiminh-dev",
        "UseSSL": false
      },
      // ... c√°c c·∫•u h√¨nh kh√°c
    }
    ```
    *   **L∆∞u √Ω:** `your_postgres_user` v√† `your_postgres_password_local_dev` c·∫ßn kh·ªõp v·ªõi c·∫•u h√¨nh trong `docker-compose.yml` ho·∫∑c PostgreSQL server c·ª•c b·ªô c·ªßa b·∫°n.

3.  **Ch·∫°y c√°c services ph·ª• thu·ªôc (PostgreSQL, MinIO, Redis) b·∫±ng Docker Compose:**
    ƒê·∫£m b·∫£o b·∫°n ƒëang ·ªü th∆∞ m·ª•c g·ªëc c·ªßa d·ª± √°n (n∆°i ch·ª©a file `docker-compose.yml`).
    ```bash
    docker compose up -d postgresql minio redis
    ```
    *   L·ªánh n√†y s·∫Ω kh·ªüi t·∫°o PostgreSQL, MinIO v√† Redis d·ª±a tr√™n c·∫•u h√¨nh trong `docker-compose.yml`.
    *   **L·∫ßn ƒë·∫ßu ch·∫°y MinIO:** Truy c·∫≠p MinIO Console (th∆∞·ªùng l√† `http://localhost:9001`) v√† t·∫°o bucket c√≥ t√™n tr√πng v·ªõi `Minio:BucketName` trong `appsettings.Development.json` (v√≠ d·ª•: `daiminh-dev`).

4.  **√Åp d·ª•ng Migrations v√† Seed Data:**
    *   M·ªü terminal trong th∆∞ m·ª•c `src/web`.
    *   √Åp d·ª•ng migrations ƒë·ªÉ t·∫°o schema cho PostgreSQL:
        ```bash
        dotnet ef database update
        ```
    *   ·ª®ng d·ª•ng ƒë∆∞·ª£c c·∫•u h√¨nh ƒë·ªÉ t·ª± ƒë·ªông seed data khi kh·ªüi ch·∫°y l·∫ßn ƒë·∫ßu (th√¥ng qua `ApplicationDataSeeder`).

5.  **Ch·∫°y ·ª©ng d·ª•ng web:**
    *   B·∫°n c√≥ th·ªÉ ch·∫°y t·ª´ IDE (Visual Studio, Rider) b·∫±ng c√°ch nh·∫•n n√∫t Run/Debug.
    *   Ho·∫∑c ch·∫°y t·ª´ terminal trong th∆∞ m·ª•c `src/web`:
        ```bash
        dotnet run
        ```
    *   Truy c·∫≠p ·ª©ng d·ª•ng qua URL ƒë∆∞·ª£c hi·ªÉn th·ªã (th∆∞·ªùng l√† `http://localhost:5011` ho·∫∑c `https://localhost:7172`).
    *   **T√†i kho·∫£n Admin m·∫∑c ƒë·ªãnh (sau khi seed data):**
        *   Username: `superadmin` ho·∫∑c `admin`
        *   Password: (Xem trong `UserAndRoleSeeder.cs` - v√≠ d·ª•: `SuperAdmin123!` ho·∫∑c `Password123!`)

---

## üöÄ H∆∞·ªõng d·∫´n Tri·ªÉn khai (Deployment)

### 1. Build Docker Image
T·∫°i th∆∞ m·ª•c g·ªëc c·ªßa d·ª± √°n (ch·ª©a `Dockerfile`):
```bash
docker build -t yourusername/daiminh-web:latest .
```
Thay `yourusername/daiminh-web:latest` b·∫±ng t√™n image v√† tag b·∫°n mu·ªën.

### 2. ƒê·∫©y Image l√™n Docker Registry (v√≠ d·ª•: Docker Hub)
```bash
docker login
docker push yourusername/daiminh-web:latest
```

### 3. Chu·∫©n b·ªã Server
*   C√†i ƒë·∫∑t Docker v√† Docker Compose tr√™n server Linux (Ubuntu 24.04).
*   ƒê·∫£m b·∫£o server c√≥ ƒë·ªß t√†i nguy√™n (CPU: 2 vCPU, RAM: 4 GB, HDD: 35 GB).
*   C·∫•u h√¨nh firewall ƒë·ªÉ cho ph√©p truy c·∫≠p v√†o c√°c port c·∫ßn thi·∫øt (v√≠ d·ª•: 80, 443).

### 4. C·∫•u h√¨nh `docker-compose.yml` tr√™n Server
Sao ch√©p file `docker-compose.yml` l√™n server. Ch·ªânh s·ª≠a c√°c bi·∫øn m√¥i tr∆∞·ªùng cho ph√π h·ª£p v·ªõi m√¥i tr∆∞·ªùng production, ƒë·∫∑c bi·ªát l√†:
*   `image` c·ªßa service `web-app` ph·∫£i l√† t√™n image b·∫°n ƒë√£ push l√™n registry.
*   **Connection Strings v√† Secrets:**
    *   **KH√îNG BAO GI·ªú** hardcode credentials production tr·ª±c ti·∫øp v√†o `docker-compose.yml`.
    *   S·ª≠ d·ª•ng Docker Secrets, file `.env` (ƒë∆∞·ª£c `.gitignore` v√† ch·ªâ t·ªìn t·∫°i tr√™n server), ho·∫∑c c√°c bi·∫øn m√¥i tr∆∞·ªùng ƒë∆∞·ª£c thi·∫øt l·∫≠p tr·ª±c ti·∫øp tr√™n server.
    *   V√≠ d·ª• s·ª≠ d·ª•ng file `.env`:
        T·∫°o file `.env` c√πng c·∫•p v·ªõi `docker-compose.yml` tr√™n server:
        ```env
        DB_USER=prod_db_user
        DB_PASSWORD=SuperSecurePassword123!
        DB_NAME=daiminh_prod
        MINIO_ACCESS_KEY=prod_minio_key
        MINIO_SECRET_KEY=SuperSecureMinioSecret!
        MINIO_BUCKET_NAME=daiminh-prod
        REDIS_CONNECTION_STRING=prod_redis_host:6379
        # ... c√°c bi·∫øn kh√°c
        ```
        Sau ƒë√≥ trong `docker-compose.yml`:
        ```yaml
        # ...
        services:
          web-app:
            # ...
            environment:
              - ConnectionStrings__DefaultConnection=Host=postgresql;Port=5432;Database=${DB_NAME};Username=${DB_USER};Password=${DB_PASSWORD}
              - Minio__Endpoint=http://minio:9000 # Minio service name
              - Minio__AccessKey=${MINIO_ACCESS_KEY}
              # ...
            # ...
          postgresql:
            environment:
              POSTGRES_USER: ${DB_USER}
              POSTGRES_PASSWORD: ${DB_PASSWORD}
              POSTGRES_DB: ${DB_NAME}
            # ...
        # ...
        ```

*   **Volumes:** ƒê·∫£m b·∫£o mapping volume cho PostgreSQL, MinIO, Redis ƒë·ªÉ d·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr·ªØ b·ªÅn v·ªØng.
*   **Networking:** ƒê·∫£m b·∫£o t·∫•t c·∫£ services trong c√πng m·ªôt Docker network.
*   **Reverse Proxy (Nginx, Traefik, Caddy):**
    *   **R·∫•t khuy·∫øn ngh·ªã** s·ª≠ d·ª•ng m·ªôt reverse proxy ph√≠a tr∆∞·ªõc ·ª©ng d·ª•ng ASP.NET Core.
    *   Reverse proxy s·∫Ω x·ª≠ l√Ω:
        *   SSL/TLS termination (HTTPS).
        *   Load balancing (n·∫øu c√≥ nhi·ªÅu instance).
        *   Caching tƒ©nh.
        *   N√©n HTTP.
    *   ·ª®ng d·ª•ng ASP.NET Core b√™n trong container s·∫Ω ch·∫°y tr√™n HTTP (port 80).
    *   V√≠ d·ª• c·∫•u h√¨nh Nginx ƒë∆°n gi·∫£n (t·∫°o file trong `/etc/nginx/sites-available/daiminh`):
        ```nginx
        server {
            listen 80;
            listen [::]:80;
            server_name yourdomain.com www.yourdomain.com; # Thay b·∫±ng domain c·ªßa b·∫°n

            # Chuy·ªÉn h∆∞·ªõng HTTP sang HTTPS
            location / {
                return 301 https://$host$request_uri;
            }
        }

        server {
            listen 443 ssl http2;
            listen [::]:443 ssl http2;
            server_name yourdomain.com www.yourdomain.com;

            ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem; # ƒê∆∞·ªùng d·∫´n certificate
            ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem; # ƒê∆∞·ªùng d·∫´n private key
            # Th√™m c√°c c·∫•u h√¨nh SSL kh√°c n·∫øu c·∫ßn

            location / {
                proxy_pass http://localhost:DOCKER_HOST_PORT; # Thay DOCKER_HOST_PORT b·∫±ng port b·∫°n map cho web-app trong docker-compose
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection keep-alive;
                proxy_set_header Host $host;
                proxy_cache_bypass $http_upgrade;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
        }
        ```
        Sau ƒë√≥ t·∫°o symlink: `sudo ln -s /etc/nginx/sites-available/daiminh /etc/nginx/sites-enabled/` v√† restart Nginx: `sudo systemctl restart nginx`.
        S·ª≠ d·ª•ng Let's Encrypt (Certbot) ƒë·ªÉ l·∫•y SSL certificate mi·ªÖn ph√≠.

### 5. Ch·∫°y ·ª©ng d·ª•ng tr√™n Server
Tr√™n server, trong th∆∞ m·ª•c ch·ª©a `docker-compose.yml`:
```bash
docker compose pull # K√©o image m·ªõi nh·∫•t (n·∫øu ƒë√£ c√≥ thay ƒë·ªïi)
docker compose up -d
```
L·ªánh n√†y s·∫Ω kh·ªüi ƒë·ªông ·ª©ng d·ª•ng web c√πng v·ªõi PostgreSQL, MinIO v√† Redis.

---

## üß± C√¢u l·ªánh Entity Framework Core

Lu√¥n ch·∫°y c√°c l·ªánh EF Core t·ª´ th∆∞ m·ª•c `src/web` (ho·∫∑c th∆∞ m·ª•c ch·ª©a project startup) v√† ch·ªâ ƒë·ªãnh project ch·ª©a DbContext (`infrastructure`).

1.  **Th√™m m·ªôt Migration:**
    T·∫°o m·ªôt t·ªáp migration m·ªõi ghi l·∫°i c√°c thay ƒë·ªïi trong model.
    ```bash
    dotnet ef migrations add TenMigrationCuaBan --project ../infrastructure --startup-project .
    ```
    Ho·∫∑c t·ª´ th∆∞ m·ª•c g·ªëc:
    ```bash
    dotnet ef migrations add TenMigrationCuaBan --project ./src/infrastructure/infrastructure.csproj --startup-project ./src/web/web.csproj
    ```

2.  **√Åp d·ª•ng Migration v√†o Database:**
    ```bash
    dotnet ef database update --project ../infrastructure --startup-project .
    ```
    Ho·∫∑c t·ª´ th∆∞ m·ª•c g·ªëc:
    ```bash
    dotnet ef database update --project ./src/infrastructure/infrastructure.csproj --startup-project ./src/web/web.csproj
    ```

3.  **X√≥a Migration Cu·ªëi c√πng (n·∫øu c·∫ßn):**
    ```bash
    dotnet ef migrations remove --project ../infrastructure --startup-project .
    ```
    Ho·∫∑c t·ª´ th∆∞_m·ª•c_g·ªëc:
    ```bash
    dotnet ef migrations remove --project ./src/infrastructure/infrastructure.csproj --startup-project ./src/web/web.csproj
    ```

### C√†i ƒë·∫∑t EF Core Tools (n·∫øu ch∆∞a c√≥)
```bash
dotnet tool install --global dotnet-ef
# Ho·∫∑c c·∫≠p nh·∫≠t:
# dotnet tool update --global dotnet-ef
```

---