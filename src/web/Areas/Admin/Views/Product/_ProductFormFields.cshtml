@using shared.Helpers
@using web.Areas.Admin.ViewModels.Product
@model ProductViewModel

@* --- TABS --- *@
<ul class="nav nav-tabs nav-fill mb-3" data-bs-toggle="tabs">
	<li class="nav-item">
		<a href="#tab-basic-info" class="nav-link active" data-bs-toggle="tab">
			<i class="ti ti-info-circle me-2"></i> Thông tin cơ bản
		</a>
	</li>
	<li class="nav-item">
		<a href="#tab-descriptions" class="nav-link" data-bs-toggle="tab">
			<i class="ti ti-file-text me-2"></i> Mô tả & Chi tiết
		</a>
	</li>
	<li class="nav-item">
		<a href="#tab-images" class="nav-link" data-bs-toggle="tab">
			<i class="ti ti-photo me-2"></i> Hình ảnh
		</a>
	</li>
	<li class="nav-item">
		<a href="#tab-variants" class="nav-link" data-bs-toggle="tab">
			<i class="ti ti-adjustments-alt me-2"></i> Biến thể & Kho
		</a>
	</li>
	<li class="nav-item">
		<a href="#tab-relations" class="nav-link" data-bs-toggle="tab">
			<i class="ti ti-tags me-2"></i> Phân loại
		</a>
	</li>
	<li class="nav-item">
		<a href="#tab-seo" class="nav-link" data-bs-toggle="tab">
			<i class="ti ti-search me-2"></i> Tối ưu SEO
		</a>
	</li>
</ul>

@* --- TAB CONTENT --- *@
<div class="tab-content">
	@* --- Tab: Basic Info --- *@
	<div class="tab-pane active show" id="tab-basic-info">
		<div class="row">
			<div class="col-md-8">
				<div class="form-group mb-3">
					<label asp-for="Name" class="form-label required">Tên sản phẩm</label>
					<input asp-for="Name" class="form-control" id="productName" />
					<span asp-validation-for="Name" class="text-danger"></span>
				</div>
				<div class="form-group mb-3">
					<label asp-for="Slug" class="form-label required">Slug</label>
					<div class="input-group">
						<input asp-for="Slug" class="form-control" id="productSlug" />
						<button class="btn btn-outline-secondary" type="button" id="generateSlugButton"> <i class="ti ti-refresh"></i> </button>
					</div>
					<span asp-validation-for="Slug" class="text-danger"></span>
				</div>
				<div class="form-group mb-3">
					<label asp-for="ShortDescription" class="form-label">Mô tả ngắn</label>
					<textarea asp-for="ShortDescription" class="form-control" rows="3"></textarea>
					<span asp-validation-for="ShortDescription" class="text-danger"></span>
				</div>
			</div>
			<div class="col-md-4">
				<div class="form-group mb-3">
					<label asp-for="ProductTypeId" class="form-label required">Loại sản phẩm</label>
					<select asp-for="ProductTypeId" asp-items="@Model.ProductTypeList" class="form-select">
						<option value="">-- Chọn loại --</option>
					</select>
					<span asp-validation-for="ProductTypeId" class="text-danger"></span>
				</div>
				<div class="form-group mb-3">
					<label asp-for="BrandId" class="form-label">Thương hiệu</label>
					<select asp-for="BrandId" asp-items="@Model.BrandList" class="form-select">
						<option value="">-- Chọn thương hiệu --</option>
					</select>
					<span asp-validation-for="BrandId" class="text-danger"></span>
				</div>
				<div class="form-group mb-3">
					<label asp-for="Status" class="form-label required">Trạng thái</label>
					<select asp-for="Status" asp-items="@Model.StatusList" class="form-select"></select>
					<span asp-validation-for="Status" class="text-danger"></span>
				</div>
				<div class="form-check form-switch mb-3">
					<input class="form-check-input" type="checkbox" asp-for="IsActive" role="switch" id="productIsActiveSwitch">
					<label class="form-check-label" for="productIsActiveSwitch">Hiển thị</label>
				</div>
				<div class="form-check form-switch mb-3">
					<input class="form-check-input" type="checkbox" asp-for="IsFeatured" role="switch" id="productIsFeaturedSwitch">
					<label class="form-check-label" for="productIsFeaturedSwitch">Nổi bật</label>
				</div>
				<div class="form-group mb-3">
					<label asp-for="Manufacturer" class="form-label">Nhà sản xuất</label>
					<input asp-for="Manufacturer" class="form-control" />
					<span asp-validation-for="Manufacturer" class="text-danger"></span>
				</div>
				<div class="form-group mb-3">
					<label asp-for="Origin" class="form-label">Xuất xứ</label>
					<input asp-for="Origin" class="form-control" />
					<span asp-validation-for="Origin" class="text-danger"></span>
				</div>
			</div>
		</div>
	</div>

	@* --- Tab: Descriptions --- *@
	<div class="tab-pane" id="tab-descriptions">
		<div class="form-group mb-3">
			<label asp-for="Description" class="form-label required">Mô tả chi tiết</label>
			<textarea asp-for="Description" class="form-control summernote" rows="15" id="productDescriptionEditor"></textarea> 
			<span asp-validation-for="Description" class="text-danger"></span>
		</div>
		<div class="row">
			<div class="col-md-6">
				<div class="form-group mb-3">
					<label asp-for="Specifications" class="form-label">Thông số kỹ thuật</label>
					<textarea asp-for="Specifications" class="form-control summernote" rows="8"></textarea>
					<span asp-validation-for="Specifications" class="text-danger"></span>
				</div>
				<div class="form-group mb-3">
					<label asp-for="Features" class="form-label">Tính năng nổi bật</label>
					<textarea asp-for="Features" class="form-control summernote" rows="8"></textarea>
					<span asp-validation-for="Features" class="text-danger"></span>
				</div>
				<div class="form-group mb-3">
					<label asp-for="ApplicationAreas" class="form-label">Khu vực ứng dụng</label>
					<textarea asp-for="ApplicationAreas" class="form-control" rows="5"></textarea>
					<span asp-validation-for="ApplicationAreas" class="text-danger"></span>
				</div>
			</div>
			<div class="col-md-6">
				<div class="form-group mb-3">
					<label asp-for="Usage" class="form-label">Hướng dẫn sử dụng</label>
					<textarea asp-for="Usage" class="form-control summernote" rows="8"></textarea>
					<span asp-validation-for="Usage" class="text-danger"></span>
				</div>
				<div class="form-group mb-3">
					<label asp-for="PackagingInfo" class="form-label">Thông tin đóng gói</label>
					<textarea asp-for="PackagingInfo" class="form-control" rows="5"></textarea>
					<span asp-validation-for="PackagingInfo" class="text-danger"></span>
				</div>
				<div class="form-group mb-3">
					<label asp-for="StorageInstructions" class="form-label">Hướng dẫn bảo quản</label>
					<textarea asp-for="StorageInstructions" class="form-control" rows="5"></textarea>
					<span asp-validation-for="StorageInstructions" class="text-danger"></span>
				</div>
				<div class="form-group mb-3">
					<label asp-for="SafetyInfo" class="form-label">Thông tin an toàn</label>
					<textarea asp-for="SafetyInfo" class="form-control" rows="5"></textarea>
					<span asp-validation-for="SafetyInfo" class="text-danger"></span>
				</div>
			</div>
		</div>
		<div class="form-group mb-3">
			<label asp-for="TechnicalDocuments" class="form-label">Tài liệu kỹ thuật (JSON)</label>
			<textarea asp-for="TechnicalDocuments" class="form-control" rows="5" placeholder='[{"name": "TDS", "url": "..."}, {"name": "MSDS", "url": "..."}]'></textarea>
			<span asp-validation-for="TechnicalDocuments" class="text-danger"></span>
			<small class="form-hint">Nhập cấu trúc JSON cho các tài liệu liên quan.</small>
		</div>
	</div>

	@* --- Tab: Images --- *@
	<div class="tab-pane" id="tab-images">
		<div class="d-flex justify-content-between align-items-center mb-3">
			<h3 class="m-0">Quản lý Hình ảnh Sản phẩm</h3>
			<button type="button" class="btn btn-outline-primary" id="selectProductImagesBtn">
				<i class="ti ti-photo-plus me-2"></i> Chọn ảnh từ thư viện
			</button>
		</div>

		@* Container for selected images *@
		<div id="product-image-list" class="row g-3">
			@* JS will render images here using a template *@
			@for (int i = 0; i < Model.Images.Count; i++)
			{
				@* Render existing images initially - SAME AS BEFORE *@
				<div class="col-md-6 col-lg-4 col-xl-3 product-image-item" data-index="@i" data-image-path="@Model.Images[i].ImageUrl">
					@* Add data-image-path for duplicate check *@
					<input type="hidden" asp-for="Images[i].Id" />
					<input type="hidden" asp-for="Images[i].ImageUrl" class="image-url-input" /> @* MinIO Path *@
					<input type="hidden" asp-for="Images[i].ThumbnailUrl" class="thumb-url-input" /> @* MinIO Thumb Path (if used) *@
					<input type="hidden" asp-for="Images[i].IsDeleted" class="is-deleted-input" value="false" />
					<div class="card">
						@* Use helper for preview *@
						<div class="img-responsive img-responsive-16x9 card-img-top image-preview"
							 style="background-image: url(@MediaUrlHelper.GetMinioUrl(Model.Images[i].ThumbnailUrl ?? Model.Images[i].ImageUrl, "/img/placeholder.svg"))"></div>
						<div class="card-body">
							<div class="form-group mb-2">
								<label asp-for="Images[i].AltText" class="form-label form-label-sm">Alt Text</label>
								<input asp-for="Images[i].AltText" class="form-control form-control-sm" />
							</div>
							<div class="form-group mb-2">
								<label asp-for="Images[i].Title" class="form-label form-label-sm">Title</label>
								<input asp-for="Images[i].Title" class="form-control form-control-sm" />
							</div>
							<div class="row g-2 align-items-center">
								<div class="col">
									<div class="form-check form-switch">
										<input class="form-check-input is-main-input" type="radio" asp-for="Images[i].IsMain" value="true" name="Images[@i].IsMainRadio" id="isMain_@i">
										<input type="hidden" asp-for="Images[i].IsMain" class="is-main-hidden" />
										<label class="form-check-label form-label-sm" for="isMain_@i">Ảnh chính</label>
									</div>
								</div>
								<div class="col-auto">
									<input type="number" asp-for="Images[i].OrderIndex" class="form-control form-control-sm order-index-input" style="width: 60px;" title="Thứ tự" />
								</div>
								<div class="col-auto">
									<button type="button" class="btn btn-sm btn-outline-danger remove-image-btn" title="Gỡ ảnh này"><i class="ti ti-trash"></i></button>
								</div>
							</div>
						</div>
					</div>
				</div>
			}
			<span asp-validation-for="Images" class="text-danger col-12"></span> @* General validation message *@
		</div>

		@* Template for NEWLY SELECTED images (hidden) - Removed progress bar *@
		<template id="product-image-template">
			<div class="col-md-6 col-lg-4 col-xl-3 product-image-item" data-index="__INDEX__" data-image-path="__IMAGE_PATH__">
				<input type="hidden" name="Images[__INDEX__].Id" value="0" /> @* New association *@
				<input type="hidden" name="Images[__INDEX__].ImageUrl" class="image-url-input" /> @* MinIO Path from selection *@
				<input type="hidden" name="Images[__INDEX__].ThumbnailUrl" class="thumb-url-input" />@* MinIO Path from selection *@
				<input type="hidden" name="Images[__INDEX__].IsDeleted" class="is-deleted-input" value="false" />
				<div class="card">
					@* Show preview immediately *@
					<div class="img-responsive img-responsive-16x9 card-img-top image-preview" style="background-image: url(/img/placeholder.svg)"></div>
					<div class="card-body">
						<div class="form-group mb-2">
							<label name="Images[__INDEX__].AltText" class="form-label form-label-sm">Alt Text</label>
							<input name="Images[__INDEX__].AltText" class="form-control form-control-sm" />
						</div>
						<div class="form-group mb-2">
							<label name="Images[__INDEX__].Title" class="form-label form-label-sm">Title</label>
							<input name="Images[__INDEX__].Title" class="form-control form-control-sm" />
						</div>
						<div class="row g-2 align-items-center">
							<div class="col">
								<div class="form-check form-switch">
									<input class="form-check-input is-main-input" type="radio" name="Images[__INDEX__].IsMainRadio" id="isMain___INDEX__">
									<input type="hidden" name="Images[__INDEX__].IsMain" class="is-main-hidden" value="false" />
									<label class="form-check-label form-label-sm" for="isMain___INDEX__">Ảnh chính</label>
								</div>
							</div>
							<div class="col-auto">
								<input type="number" name="Images[__INDEX__].OrderIndex" class="form-control form-control-sm order-index-input" value="0" style="width: 60px;" title="Thứ tự" />
							</div>
							<div class="col-auto">
								<button type="button" class="btn btn-sm btn-outline-danger remove-image-btn" title="Gỡ ảnh này"><i class="ti ti-trash"></i></button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</template>
	</div>

	@* --- Tab: Variants --- *@
	<div class="tab-pane" id="tab-variants">
		<h3 class="mb-3">Biến thể Sản phẩm & Kho hàng</h3>
		<span asp-validation-for="Variants" class="text-danger d-block mb-2"></span> @* General validation for variants *@
		<div id="product-variant-list">
			@* JS will render variants here using a template *@
			@for (int i = 0; i < Model.Variants.Count; i++)
			{
				<div class="card mb-3 product-variant-item" data-index="@i">
					<input type="hidden" asp-for="Variants[i].Id" />
					<input type="hidden" asp-for="Variants[i].IsDeleted" class="is-deleted-input" value="false" />
					<div class="card-body">
						<div class="row g-3">
							<div class="col-md-4">
								<label asp-for="Variants[i].Name" class="form-label required">Tên biến thể</label>
								<input asp-for="Variants[i].Name" class="form-control" />
								<span asp-validation-for="Variants[i].Name" class="text-danger"></span>
							</div>
							<div class="col-md-3">
								<label asp-for="Variants[i].Sku" class="form-label required">SKU</label>
								<input asp-for="Variants[i].Sku" class="form-control" />
								<span asp-validation-for="Variants[i].Sku" class="text-danger"></span>
							</div>
							<div class="col-md-2">
								<label asp-for="Variants[i].Price" class="form-label required">Giá</label>
								<input type="number" asp-for="Variants[i].Price" class="form-control" step="any" min="0" />
								<span asp-validation-for="Variants[i].Price" class="text-danger"></span>
							</div>
							<div class="col-md-2">
								<label asp-for="Variants[i].StockQuantity" class="form-label">Tồn kho</label>
								<input type="number" asp-for="Variants[i].StockQuantity" class="form-control" min="0" />
								<span asp-validation-for="Variants[i].StockQuantity" class="text-danger"></span>
							</div>
							<div class="col-md-1 d-flex align-items-end">
								<button type="button" class="btn btn-outline-danger remove-variant-btn" title="Xóa biến thể này"><i class="ti ti-trash"></i></button>
							</div>
							@* Optional fields *@
							<div class="col-md-3">
								<label asp-for="Variants[i].Color" class="form-label">Màu sắc</label>
								<input asp-for="Variants[i].Color" class="form-control" />
							</div>
							<div class="col-md-3">
								<label asp-for="Variants[i].Size" class="form-label">Kích thước/Dung tích</label>
								<input asp-for="Variants[i].Size" class="form-control" />
							</div>
							<div class="col-md-3">
								<label asp-for="Variants[i].Packaging" class="form-label">Đóng gói</label>
								<input asp-for="Variants[i].Packaging" class="form-control" />
							</div>
							<div class="col-md-3 d-flex align-items-center">
								<div class="form-check form-switch">
									<input class="form-check-input" type="checkbox" asp-for="Variants[i].IsActive" role="switch" id="variantActive_@i">
									<label class="form-check-label" for="variantActive_@i">Hoạt động</label>
								</div>
							</div>
							@* Add variant image selection if needed *@
						</div>
					</div>
				</div>
			}
		</div>
		<button type="button" class="btn btn-outline-primary mt-2" id="add-variant-btn">
			<i class="ti ti-plus me-1"></i> Thêm biến thể
		</button>
		@* Template for new variants (hidden) *@
		<template id="product-variant-template">
			<div class="card mb-3 product-variant-item" data-index="__INDEX__">
				<input type="hidden" name="Variants[__INDEX__].Id" value="0" />
				<input type="hidden" name="Variants[__INDEX__].IsDeleted" class="is-deleted-input" value="false" />
				<div class="card-body">
					<div class="row g-3">
						<div class="col-md-4">
							<label name="Variants[__INDEX__].Name" class="form-label required">Tên biến thể</label>
							<input name="Variants[__INDEX__].Name" class="form-control" />
							@* Validation span added by JS/jQuery validate *@
						</div>
						<div class="col-md-3">
							<label name="Variants[__INDEX__].Sku" class="form-label required">SKU</label>
							<input name="Variants[__INDEX__].Sku" class="form-control" />
						</div>
						<div class="col-md-2">
							<label name="Variants[__INDEX__].Price" class="form-label required">Giá</label>
							<input type="number" name="Variants[__INDEX__].Price" class="form-control" step="any" min="0" value="0" />
						</div>
						<div class="col-md-2">
							<label name="Variants[__INDEX__].StockQuantity" class="form-label">Tồn kho</label>
							<input type="number" name="Variants[__INDEX__].StockQuantity" class="form-control" min="0" value="0" />
						</div>
						<div class="col-md-1 d-flex align-items-end">
							<button type="button" class="btn btn-outline-danger remove-variant-btn" title="Xóa biến thể này"><i class="ti ti-trash"></i></button>
						</div>
						<div class="col-md-3"> <label name="Variants[__INDEX__].Color" class="form-label">Màu sắc</label> <input name="Variants[__INDEX__].Color" class="form-control" /> </div>
						<div class="col-md-3"> <label name="Variants[__INDEX__].Size" class="form-label">Kích thước/Dung tích</label> <input name="Variants[__INDEX__].Size" class="form-control" /> </div>
						<div class="col-md-3"> <label name="Variants[__INDEX__].Packaging" class="form-label">Đóng gói</label> <input name="Variants[__INDEX__].Packaging" class="form-control" /> </div>
						<div class="col-md-3 d-flex align-items-center">
							<div class="form-check form-switch">
								<input class="form-check-input" type="checkbox" name="Variants[__INDEX__].IsActive" value="true" role="switch" id="variantActive___INDEX__" checked> @* Default to active *@
								<input type="hidden" name="Variants[__INDEX__].IsActive" value="false" /> @* Fallback for unchecked *@
								<label class="form-check-label" for="variantActive___INDEX__">Hoạt động</label>
							</div>
						</div>
					</div>
				</div>
			</div>
		</template>
	</div>

	@* --- Tab: Relations (Categories & Tags) --- *@
	<div class="tab-pane" id="tab-relations">
		<div class="row">
			<div class="col-md-6">
				<div class="form-group mb-3">
					<label asp-for="SelectedCategoryIds" class="form-label required">Danh mục</label>
					@* Use Select2 for multi-select *@
					<select asp-for="SelectedCategoryIds" asp-items="@Model.CategoryList" class="form-select select2-multiple" multiple="multiple"></select>
					<span asp-validation-for="SelectedCategoryIds" class="text-danger"></span>
					<small class="form-hint">Chọn một hoặc nhiều danh mục.</small>
				</div>
			</div>
			<div class="col-md-6">
				<div class="form-group mb-3">
					<label asp-for="SelectedTagIds" class="form-label">Thẻ (Tags)</label>
					<select asp-for="SelectedTagIds" asp-items="@Model.TagList" class="form-select select2-multiple" multiple="multiple"></select>
					<span asp-validation-for="SelectedTagIds" class="text-danger"></span>
					<small class="form-hint">Chọn các thẻ liên quan.</small>
				</div>
			</div>
		</div>
	</div>

	@* --- Tab: SEO --- *@
	<div class="tab-pane" id="tab-seo">
		@* Copy SEO fields from _BrandFormFields.cshtml or _CategoryFormFields.cshtml *@
		<div class="form-group mb-3">
			<label asp-for="MetaTitle" class="form-label">Meta Title</label>
			<input asp-for="MetaTitle" class="form-control" />
			<span asp-validation-for="MetaTitle" class="text-danger"></span>
		</div>
		<div class="form-group mb-3">
			<label asp-for="MetaDescription" class="form-label">Meta Description</label>
			<textarea asp-for="MetaDescription" class="form-control" rows="3"></textarea>
			<span asp-validation-for="MetaDescription" class="text-danger"></span>
		</div>
		@* Add other SEO fields... *@
	</div>
</div>