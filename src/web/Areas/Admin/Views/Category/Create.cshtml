@using web.Areas.Admin.ViewModels.Category
@model CategoryViewModel
@{
	ViewData["Title"] = "Thêm danh mục - Hệ thống quản trị";
}

<div class="card">
	<div class="card-body">
		<form asp-action="Create" method="post" enctype="multipart/form-data">
			<div asp-validation-summary="ModelOnly" class="text-danger"></div>
			<input type="hidden" asp-for="Type" />

			<div class="row mb-3">
				<div class="col-md-8">
					<div class="form-group mb-3">
						<label asp-for="Name" class="form-label required">Tên danh mục</label>
						<input asp-for="Name" class="form-control" id="categoryName" />
						<span asp-validation-for="Name" class="text-danger"></span>
					</div>

					<div class="form-group mb-3">
						<label asp-for="Slug" class="form-label required">Slug</label>
						<div class="input-group">
							<input asp-for="Slug" class="form-control" id="categorySlug" />
							<button class="btn btn-outline-secondary" type="button" id="generateSlug">
								<i class="ti ti-refresh"></i>
							</button>
						</div>
						<span asp-validation-for="Slug" class="text-danger"></span>
						<small class="form-hint">Dùng cho URL (chỉ chứa chữ cái thường, số và dấu gạch ngang)</small>
					</div>

					<div class="form-group mb-3">
						<label asp-for="Description" class="form-label">Mô tả</label>
						<textarea asp-for="Description" class="form-control" rows="3"></textarea>
						<span asp-validation-for="Description" class="text-danger"></span>
						<small class="form-hint">Mô tả ngắn về danh mục (tối đa 255 ký tự)</small>
					</div>

					<div class="form-group mb-3">
						<label asp-for="ParentId" class="form-label">Danh mục cha</label>
						<select asp-for="ParentId" class="form-select">
							<option value="">-- Không có danh mục cha --</option>
							@if (Model.AvailableParents != null)
							{
								@foreach (var parent in Model.AvailableParents)
								{
									<option value="@parent.Id">@parent.DisplayName</option>
								}
							}
						</select>
						<span asp-validation-for="ParentId" class="text-danger"></span>
					</div>
				</div>

				<div class="col-md-4">
					<div class="form-group mb-3">
						<label asp-for="Icon" class="form-label">Icon (Tabler Class)</label>
						<input asp-for="Icon" class="form-control" />
						<span asp-validation-for="Icon" class="text-danger"></span>
						<small class="form-hint">Ví dụ: ti ti-home (<a href="https://tabler-icons.io/" target="_blank">Tabler Icons</a>)</small>
					</div>

					<div class="form-group mb-3">
						@* Update to use Media Browser *@
						<label asp-for="ImageUrl" class="form-label">Hình ảnh</label>
						<input asp-for="ImageUrl" id="categoryImageUrlInput" class="form-control" type="hidden" />
						<span asp-validation-for="ImageUrl" class="text-danger"></span>

						<div id="category-image-preview-container" class="border rounded p-3 mb-2 text-center d-flex align-items-center justify-content-center" style="min-height: 120px;">
							<div class="media-placeholder">
								<i class="ti ti-photo text-muted" style="font-size: 2.5rem;"></i>
								<p class="mt-2 mb-0 text-muted small">Chưa có ảnh</p>
							</div>
						</div>

						<div class="d-flex justify-content-between align-items-center">
							<button type="button" class="btn btn-outline-primary btn-sm" onclick="openMediaBrowser('handleSelectedCategoryImage', 'image')">
								<i class="ti ti-folder-open me-1"></i> Chọn/Thay đổi
							</button>
							<button type="button" id="remove-category-image-button" class="btn btn-outline-danger btn-sm d-none" onclick="removeSelectedCategoryImage()">
								<i class="ti ti-trash me-1"></i> Xóa
							</button>
						</div>
						<small class="form-hint mt-1 d-block">Ảnh đại diện cho danh mục</small>
					</div>


					<div class="form-group mb-3">
						<label asp-for="OrderIndex" class="form-label">Thứ tự hiển thị</label>
						<input asp-for="OrderIndex" class="form-control" type="number" min="0" value="0" />
						<span asp-validation-for="OrderIndex" class="text-danger"></span>
						<small class="form-hint">Số thấp hơn sẽ hiển thị trước</small>
					</div>

					<div class="form-group mb-3">
						<div class="form-check form-switch">
							<input asp-for="IsActive" class="form-check-input" type="checkbox" checked />
							<label asp-for="IsActive" class="form-check-label">Hiển thị danh mục</label>
						</div>
						<span asp-validation-for="IsActive" class="text-danger"></span>
					</div>
				</div>
			</div>

			<!-- SEO Section -->
			<div class="card mt-4 mb-3">
				<div class="card-header">
					<h3 class="card-title">Thông tin SEO</h3>
				</div>
				<div class="card-body">
					<div class="row">
						<div class="col-md-6">
							<div class="form-group mb-3">
								<label asp-for="MetaTitle" class="form-label">Meta Title</label>
								<input asp-for="MetaTitle" class="form-control" />
								<span asp-validation-for="MetaTitle" class="text-danger"></span>
								<small class="form-hint">Tiêu đề hiển thị trên kết quả tìm kiếm (để trống sẽ dùng tên danh mục)</small>
							</div>

							<div class="form-group mb-3">
								<label asp-for="MetaDescription" class="form-label">Meta Description</label>
								<textarea asp-for="MetaDescription" class="form-control" rows="3"></textarea>
								<span asp-validation-for="MetaDescription" class="text-danger"></span>
								<small class="form-hint">Mô tả hiển thị trên kết quả tìm kiếm (để trống sẽ dùng mô tả danh mục)</small>
							</div>
						</div>

						<div class="col-md-6">
							<div class="form-group mb-3">
								<label asp-for="MetaKeywords" class="form-label">Meta Keywords</label>
								<textarea asp-for="MetaKeywords" class="form-control" rows="3"></textarea>
								<span asp-validation-for="MetaKeywords" class="text-danger"></span>
								<small class="form-hint">Từ khóa cho công cụ tìm kiếm (phân cách bằng dấu phẩy)</small>
							</div>

							<div class="form-group mb-3">
								<div class="form-check form-switch">
									<input asp-for="NoIndex" class="form-check-input" type="checkbox" />
									<label asp-for="NoIndex" class="form-check-label">Không cho phép Google lập chỉ mục</label>
								</div>
								<span asp-validation-for="NoIndex" class="text-danger"></span>
								<small class="form-hint">Khi bật, trang này sẽ không xuất hiện trong kết quả tìm kiếm</small>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="d-flex justify-content-between mt-4">
				<a asp-action="Index" asp-route-type="@Model.Type" class="btn btn-outline-secondary">
					<i class="ti ti-arrow-left me-2"></i> Quay lại
				</a>
				<button type="submit" class="btn btn-primary">
					<i class="ti ti-device-floppy me-2"></i> Lưu danh mục
				</button>
			</div>
		</form>
	</div>
</div>

@section Scripts {
	<script>
		// Function to generate slug
		function generateSlug() {
			var name = $('#categoryName').val();
			if (name) {
				var slug = name.toLowerCase();

				// Convert Vietnamese characters to basic Latin characters
				slug = slug.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
				slug = slug.replace(/đ/g, 'd').replace(/Đ/g, 'D'); // Handle 'đ' character

				slug = slug.replace(/\s+/g, '-') // Replace spaces with hyphens
					.replace(/[^\w\-]+/g, '') // Remove all non-word chars except hyphens
					.replace(/\-\-+/g, '-') // Replace multiple hyphens with a single one
					.replace(/^-+/, '') // Trim hyphens from start
					.replace(/-+$/, ''); // Trim hyphens from end

				$('#categorySlug').val(slug);
			} else {
				$('#categorySlug').val(''); // Clear slug if name is empty
			}
		}

		// Function to handle the selected category image
		function handleSelectedCategoryImage(fileData) {
			console.log('Category Image Selected:', fileData);
			const previewContainer = document.getElementById('category-image-preview-container');
			const fileInput = document.getElementById('categoryImageUrlInput'); // Use the correct ID
			const removeButton = document.getElementById('remove-category-image-button');

			 if (fileData && fileData.url && fileInput && previewContainer && removeButton) {
				// Check if the selected file is an image
				const fileExt = fileData.url.split('.').pop().toLowerCase();
				const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'];

				if (!imageExts.includes(fileExt)) {
					toastr.error('Vui lòng chọn một file hình ảnh (jpg, png, gif, etc).');
					return; // Stop if not an image
				}

				// Update hidden input with the file URL
				fileInput.value = fileData.url;

				// Update the preview area
				previewContainer.innerHTML = `
					<div class="media-item d-flex flex-column align-items-center">
						<img src="${fileData.url}" alt="${fileData.filename || 'Preview'}" class="img-thumbnail mb-2" style="max-height: 100px; max-width: 100%;">
						<small class="text-muted text-truncate" style="max-width: 100%;" title="${fileData.filename || ''}">${fileData.filename || 'Selected Image'}</small>
					</div>
				`;
				previewContainer.classList.remove('text-center'); // Adjust alignment

				// Show the remove button
				removeButton.classList.remove('d-none');
			} else {
				console.error("Missing elements or file data for category image handling.");
				toastr.error('Có lỗi xảy ra khi chọn ảnh danh mục.');
			}
		}

		// Function to remove the selected category image
		function removeSelectedCategoryImage() {
			const previewContainer = document.getElementById('category-image-preview-container');
			const fileInput = document.getElementById('categoryImageUrlInput'); // Use the correct ID
			const removeButton = document.getElementById('remove-category-image-button');

			if (previewContainer && fileInput && removeButton) {
				// Clear the hidden input
				fileInput.value = '';

				// Reset the preview area
				 previewContainer.innerHTML = `
					<div class="media-placeholder">
						<i class="ti ti-photo text-muted" style="font-size: 2.5rem;"></i>
						<p class="mt-2 mb-0 text-muted small">Chưa có ảnh</p>
					</div>
				`;
				previewContainer.classList.add('text-center'); // Ensure placeholder is centered

				// Hide the remove button
				removeButton.classList.add('d-none');
			} else {
				 console.error("Missing elements for category image removal.");
			}
		}


		$(document).ready(function() {
			$('#categoryName').on('input', function() {
				if ($('#categorySlug').val() === '') {
					generateSlug();
				}
			});

			$('#generateSlug').on('click', function() {
				generateSlug();
			});

			 if ($('form[asp-action="Create"]').length > 0) {
				 const isActiveCheckbox = document.getElementById('IsActive');
				 if (isActiveCheckbox && !isActiveCheckbox.checked) {
					isActiveCheckbox.checked = true;
				 }
			 }

			const initialImageUrl = $('#categoryImageUrlInput').val();
			if (initialImageUrl) {
				handleSelectedCategoryImage({
					 url: initialImageUrl,
					 filename: initialImageUrl.substring(initialImageUrl.lastIndexOf('/') + 1)
				 });
			 } else {
				 removeSelectedCategoryImage();
			 }

		});
	</script>
}