@using web.Areas.Admin.ViewModels.Media
@model MediaUploadViewModel
@{
    ViewData["Title"] = "Tải lên file - Hệ thống quản trị";
}

<div class="card">
    <div class="card-body">
        <form asp-action="Upload" method="post" enctype="multipart/form-data">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="row mb-3">
                <div class="col-md-8">
                    <div class="form-group mb-3">
                        <label asp-for="Files" class="form-label required">Chọn file</label>
                        <input asp-for="Files" class="form-control" type="file" multiple />
                        <span asp-validation-for="Files" class="text-danger"></span>
                        <small class="form-hint">Kích thước tối đa: 20MB mỗi file. Bạn có thể chọn nhiều file cùng lúc.</small>
                    </div>

					<div class="file-preview-container mt-3 mb-3" style="display: none;">
						<h4>Xem trước</h4>
						<div class="row" id="file-preview-list"></div>
					</div>

                    <div class="form-group mb-3">
                        <label asp-for="Description" class="form-label">Mô tả</label>
                        <textarea asp-for="Description" class="form-control" rows="3"></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                        <small class="form-hint">Mô tả ngắn về file (tối đa 255 ký tự)</small>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label asp-for="FolderId" class="form-label">Thư mục</label>
                        <select asp-for="FolderId" class="form-select">
                            <option value="">-- Thư mục gốc --</option>
                            @if (Model.AvailableFolders != null)
                            {
                                @foreach (var folder in Model.AvailableFolders)
                                {
                                    <option value="@folder.Id">@folder.DisplayName</option>
                                }
                            }
                        </select>
                        <span asp-validation-for="FolderId" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="AltText" class="form-label">Alt Text (cho hình ảnh)</label>
                        <input asp-for="AltText" class="form-control" />
                        <span asp-validation-for="AltText" class="text-danger"></span>
                        <small class="form-hint">Văn bản thay thế cho hình ảnh, hỗ trợ SEO và trình đọc màn hình</small>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <a asp-action="Index" asp-route-folderId="@Model.FolderId" class="btn btn-outline-secondary">
                    <i class="ti ti-arrow-left me-2"></i> Quay lại
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="ti ti-upload me-2"></i> Tải lên
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
	<script>
		$(document).ready(function() {
			$('#Files').on('change', function() {
				var fileCount = this.files ? this.files.length : 0;
				var $hint = $(this).closest('.form-group').find('.form-hint');
				var $previewContainer = $('.file-preview-container');
				var $previewList = $('#file-preview-list');

				if (fileCount > 0) {
					$hint.text('Đã chọn ' + fileCount + ' file.');
					$previewList.empty();
					$previewContainer.show();

					for (var i = 0; i < fileCount; i++) {
						var file = this.files[i];
						var reader = new FileReader();
						var $preview = $('<div class="col-md-3 mb-3"></div>');
						var $card = $('<div class="card"></div>');
						var $cardBody = $('<div class="card-body p-2"></div>');

						reader.onload = (function(file, $card) {
							return function(e) {
								var fileType = file.type.split('/')[0];
								var $content = $('<div class="text-center"></div>');

								if (fileType === 'image') {
									$content.append('<img src="' + e.target.result + '" class="img-fluid mb-2" style="max-height: 100px;">');
								} else {
									var icon = 'ti-file';
									if (fileType === 'video') icon = 'ti-movie';
									else if (fileType === 'audio') icon = 'ti-music';
									else if (file.type === 'application/pdf') icon = 'ti-file-text';

									$content.append('<i class="' + icon + ' text-muted" style="font-size: 3rem;"></i>');
								}

								$content.append('<div class="text-truncate small">' + file.name + '</div>');
								$content.append('<div class="text-muted small">' + formatFileSize(file.size) + '</div>');

								$card.append($content);
							};
						})(file, $card);

						reader.readAsDataURL(file);
						$cardBody.append($card);
						$preview.append($cardBody);
						$previewList.append($preview);
					}
				} else {
					$hint.text('Kích thước tối đa: 20MB mỗi file. Bạn có thể chọn nhiều file cùng lúc.');
					$previewContainer.hide();
				}
			});

			$('#clear-files').on('click', function() {
				$('#file-upload').val('').trigger('change');
			});

			function formatFileSize(bytes) {
				if (bytes === 0) return '0 Bytes';
				var k = 1024;
				var sizes = ['Bytes', 'KB', 'MB', 'GB'];
				var i = Math.floor(Math.log(bytes) / Math.log(k));
				return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
			}
		});
	</script>
}