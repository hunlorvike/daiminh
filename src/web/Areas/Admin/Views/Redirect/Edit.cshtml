@using shared.Enums
@using web.Areas.Admin.ViewModels.Redirect
@model RedirectViewModel
@{
	ViewData["Title"] = "Chỉnh sửa chuyển hướng - Hệ thống quản trị";
}

<div class="card">
	<div class="card-body">
		<form asp-action="Edit" method="post">
			<div asp-validation-summary="ModelOnly" class="text-danger"></div>
			<input type="hidden" asp-for="Id" />
			<input type="hidden" asp-for="HitCount" />

			<div class="row mb-3">
				<div class="col-md-6">
					<div class="form-group mb-3">
						<label asp-for="SourceUrl" class="form-label required">URL nguồn</label>
						<input asp-for="SourceUrl" class="form-control" placeholder="Ví dụ: /old-page hoặc /products/old-*" />
						<span asp-validation-for="SourceUrl" class="text-danger"></span>
						<small class="form-hint">URL mà người dùng sẽ truy cập (không bao gồm tên miền)</small>
					</div>

					<div class="form-group mb-3">
						<label asp-for="TargetUrl" class="form-label required">URL đích</label>
						<input asp-for="TargetUrl" class="form-control" placeholder="Ví dụ: /new-page hoặc https://example.com/page" />
						<span asp-validation-for="TargetUrl" class="text-danger"></span>
						<small class="form-hint">URL mà người dùng sẽ được chuyển hướng đến</small>
					</div>

					<div class="form-group mb-3">
						<label asp-for="Notes" class="form-label">Ghi chú</label>
						<textarea asp-for="Notes" class="form-control" rows="3"></textarea>
						<span asp-validation-for="Notes" class="text-danger"></span>
						<small class="form-hint">Ghi chú nội bộ về chuyển hướng này (tối đa 255 ký tự)</small>
					</div>
				</div>

				<div class="col-md-6">
					<div class="form-group mb-3">
						<label asp-for="Type" class="form-label">Loại chuyển hướng</label>
						<select asp-for="Type" class="form-select">
							<option value="@RedirectType.Permanent">301 - Permanent (Vĩnh viễn)</option>
							<option value="@RedirectType.Temporary">302 - Temporary (Tạm thời)</option>
						</select>
						<span asp-validation-for="Type" class="text-danger"></span>
						<small class="form-hint">
							301: Chuyển hướng vĩnh viễn, tốt cho SEO<br>
							302: Chuyển hướng tạm thời
						</small>
					</div>

					<div class="form-group mb-3">
						<div class="form-check form-switch">
							<input asp-for="IsRegex" class="form-check-input" type="checkbox" />
							<label asp-for="IsRegex" class="form-check-label">Sử dụng Regex</label>
						</div>
						<span asp-validation-for="IsRegex" class="text-danger"></span>
						<small class="form-hint">
							Cho phép sử dụng biểu thức chính quy (regex) trong URL nguồn<br>
							Ví dụ: ^/products/([0-9]+)$ sẽ khớp với /products/123
						</small>
					</div>

					<div class="form-group mb-3">
						<div class="form-check form-switch">
							<input asp-for="IsActive" class="form-check-input" type="checkbox" />
							<label asp-for="IsActive" class="form-check-label">Kích hoạt</label>
						</div>
						<span asp-validation-for="IsActive" class="text-danger"></span>
					</div>

					<div class="form-group mb-3">
						<label asp-for="HitCount" class="form-label">Số lần truy cập</label>
						<div class="input-group">
							<input asp-for="HitCount" class="form-control" readonly />
							<button type="button" class="btn btn-outline-secondary reset-hit-count" data-id="@Model.Id">
								<i class="fas fa-redo me-2"></i> Đặt lại
							</button>
						</div>
						<span asp-validation-for="HitCount" class="text-danger"></span>
					</div>
				</div>
			</div>

			<div class="d-flex justify-content-between mt-4">
				<a asp-action="Index" class="btn btn-outline-secondary">
					<i class="fas fa-arrow-left me-2"></i> Quay lại
				</a>
				<button type="submit" class="btn btn-primary">
					<i class="fas fa-save me-2"></i> Cập nhật chuyển hướng
				</button>
			</div>
		</form>
	</div>
</div>

@section Scripts {
	<script>
		$(document).ready(function() {
			// Toggle regex help text visibility based on checkbox
			$('#IsRegex').on('change', function() {
				if ($(this).is(':checked')) {
					$('#regexHelp').removeClass('d-none');
				} else {
					$('#regexHelp').addClass('d-none');
				}
			});

			// Initialize based on current state
			if ($('#IsRegex').is(':checked')) {
				$('#regexHelp').removeClass('d-none');
			} else {
				$('#regexHelp').addClass('d-none');
			}

			// Reset hit count
			$('.reset-hit-count').on('click', function () {
				var id = $(this).data('id');
				var button = $(this);

				$.ajax({
					url: '@Url.Action("ResetHitCount", "Redirect")',
					type: 'POST',
					data: { id: id },
					success: function (result) {
						if (result.success) {
							toastr.success(result.message);
							// Update the hit count display to 0
							$('#HitCount').val('0');
						} else {
							toastr.error(result.message);
						}
					},
					error: function () {
						toastr.error('Đã xảy ra lỗi khi đặt lại số lượt truy cập');
					}
				});
			});
		});
	</script>
}

