@using web.Areas.Admin.ViewModels.Testimonial
@model TestimonialViewModel
@{
	ViewData["Title"] = "Thêm đánh giá khách hàng - Hệ thống quản trị";
}

<div class="card">
	<div class="card-body">
		<form asp-action="Create" method="post">
			<div asp-validation-summary="ModelOnly" class="text-danger"></div>
			@Html.AntiForgeryToken()

			<partial name="_TestimonialFormFields" model="Model" />

			<div class="d-flex justify-content-between mt-4">
				<a asp-action="Index" class="btn btn-outline-secondary">
					<i class="ti ti-arrow-left me-2"></i> Quay lại
				</a>
				<button type="submit" class="btn btn-primary">
					<i class="ti ti-device-floppy me-2"></i> Lưu đánh giá
				</button>
			</div>
		</form>
	</div>
</div>

@section Scripts {
	<script>
		function updateStars(rating) {
			const ratingStarsContainer = document.getElementById('ratingStars');
			if (!ratingStarsContainer) return;

			ratingStarsContainer.innerHTML = '';
			for (let i = 1; i <= 5; i++) {
				const starClass = i <= rating ? 'ti ti-star-filled text-warning' : 'ti ti-star text-warning';
				ratingStarsContainer.innerHTML += `<i class="${starClass} me-1"></i>`;
			}
		}

		$(document).ready(function() {
			const ratingSlider = document.getElementById('ratingSlider');

			if (ratingSlider) {
				let initialRating = parseInt(ratingSlider.value) || 5;
				if (initialRating < 1 || initialRating > 5) initialRating = 5;
				ratingSlider.value = initialRating;
				updateStars(initialRating);

				ratingSlider.addEventListener('input', function() {
					updateStars(parseInt(this.value));
				});
			}

			const $selectBtn = $('#selectAvatarBtn');
			const $removeBtn = $('#removeAvatarBtn');
			const $previewImg = $('#avatarPreview');
			const $pathInput = $('#avatarPathInput');
			const defaultAvatar = '/img/placeholder.svg';

			function handleAvatarSelection(selectedFile) {
				if (selectedFile && selectedFile.url && selectedFile.path) {
					$previewImg.attr('src', selectedFile.url);
					$pathInput.val(selectedFile.path).trigger('change');
					$removeBtn.removeClass('d-none');
				}
			}

			$selectBtn.on('click', function() {
				if (typeof window.openMediaSelectionModal === 'function') {
					window.openMediaSelectionModal(handleAvatarSelection, 'Image');
				} else {
					console.error('Function openMediaSelectionModal is not defined.');
					alert('Không thể mở thư viện media.');
				}
			});

			$removeBtn.on('click', function() {
				$previewImg.attr('src', defaultAvatar);
				$pathInput.val('').trigger('change');
				$(this).addClass('d-none');
			});
		});
	</script>
}
