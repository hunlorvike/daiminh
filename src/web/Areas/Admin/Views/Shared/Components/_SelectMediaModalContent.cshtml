@using web.Areas.Admin.ViewModels.Media
@model SelectMediaModalViewModel
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
@functions {
	public string GetAntiXsrfRequestToken()
	{
		return Xsrf.GetAndStoreTokens(Context).RequestToken!;
	}
}

@* Store current folder ID and other state in data attributes for JS *@
<div id="media-browser-content"
	 data-current-folder-id="@Model.CurrentFolderId"
	 data-anti-forgery-token="@GetAntiXsrfRequestToken()">

    @* Breadcrumbs *@
	<nav aria-label="breadcrumb" class="mb-2">
		<ol class="breadcrumb breadcrumb-arrows" id="modal-media-breadcrumbs">
            @* Root breadcrumb - ID 0 is placeholder for service/js logic *@
			<li class="breadcrumb-item"><a href="#" data-folder-id="">Gốc</a></li>
			@if (Model.Breadcrumbs != null)
			{
				@foreach (var breadcrumb in Model.Breadcrumbs)
				{
					<li class="breadcrumb-item @(breadcrumb.Id == Model.CurrentFolderId ? "active" : "")" @(breadcrumb.Id == Model.CurrentFolderId ? "aria-current=page" : "")>
						@if (breadcrumb.Id == Model.CurrentFolderId)
						{
							@breadcrumb.Name
						}
						else
						{
							<a href="#" data-folder-id="@breadcrumb.Id">@breadcrumb.Name</a>
						}
					</li>
				}
			}
		</ol>
	</nav>

	@* Filter and Actions Row *@
	<div class="d-flex align-items-center mb-3 gap-2">
		@* Filter by media type *@
		<select id="modal-media-type-filter" class="form-select form-select-sm" asp-items="@Model.Filter.MediaTypeOptions"></select>

		@* Upload Button / Dropzone Area Toggle *@
		<button class="btn btn-sm btn-primary ms-auto" id="toggle-upload-area">
			<i class="ti ti-upload me-1"></i> Tải lên
		</button>

		@* Create Folder Button *@
		<button class="btn btn-sm btn-secondary" id="create-folder-btn" data-parent-folder-id="@Model.CurrentFolderId">
			<i class="ti ti-folder-plus me-1"></i> Thêm thư mục
		</button>
	</div>

	@* Upload Area (initially hidden) *@
	<div id="modal-upload-area" class="mb-3 border p-3 rounded bg-light" style="display: none;">
		@* Dropzone will attach here *@
		<div id="modal-dropzone" class="dropzone text-muted text-center p-4">
			<div class="dz-message" data-dz-message><span>Kéo thả tập tin vào đây hoặc bấm để chọn</span></div>
			<div class="dropzone-previews"></div> @* For Dropzone previews *@
		</div>
		<small class="form-hint mt-2">Hỗ trợ kéo thả hoặc bấm để chọn tập tin. Dung lượng tối đa 100MB.</small>
	</div>


	@* Folder and File Grid Container *@
	<div id="media-browser-grid-container">
		@* Loading Indicator *@
		<div class="text-center p-4" id="media-browser-loading-indicator" style="display: none;">
			<div class="spinner-border text-primary" role="status"></div>
		</div>

		@* Folder List *@
		<div id="media-browser-folders" class="row row-cards row-cols-auto g-2 mb-3">
			@* Render folders here or populate via JS *@
			@if (Model.Folders != null)
			{
				@foreach (var folder in Model.Folders)
				{
					<partial name="_MediaFolderItem" model="folder" view-data='new ViewDataDictionary(ViewData) { { "IsInModal", true } }' />
				}
			}
		</div>

		@* File Grid *@
		<div id="media-browser-files" class="media-grid" style="grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 1rem;">
			@* Render files here or populate via JS *@
			@if (Model.Files != null)
			{
				@foreach (var file in Model.Files)
				{
					<partial name="_MediaFileItem" model="file" view-data='new ViewDataDictionary(ViewData) { { "IsInModal", true } }' />
				}
			}
		</div>

		@* Empty State Indicator *@
		<div class="text-center text-muted p-5" id="media-browser-empty-indicator" style="display: none;">
			<p>Thư mục này trống.</p>
		</div>
	</div>
</div>

<input type="hidden" id="selected-media-url-modal-input" value="" />
<input type="hidden" id="selected-media-alt-text-modal-input" value="" />

